---
import LayoutCommon from "../app/LayoutCommon.astro";
import LayoutProtected from "../app/LayoutProtected.astro";

// Definir las interfaces TypeScript para los datos (opcional pero recomendado)
interface ConsultaData {
  id: string | null;
  paso1: Record<string, any>;
  paso2: Record<string, any>;
  paso3: Record<string, any>;
}
---

<LayoutProtected>
<LayoutCommon>
  <div class="min-h-screen bg-gradient-to-r from-slate-100 to-slate-200 p-4 text-slate-800 dark:from-slate-900 dark:to-slate-800 dark:text-slate-100 lg:p-16">
    <div class="mx-auto max-w-4xl">
      <div class="mb-8">
        <button id="volverBtn" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
          ← Volver a consultas
        </button>
      </div>

      <div class="rounded-lg bg-white p-6 shadow-xl dark:bg-gray-800">
        <!-- Navegación entre pasos -->
        <div class="mb-8 flex justify-between">
          <button id="paso1Btn" class="paso-btn border-b-2 border-blue-600 px-4 py-2 font-semibold text-blue-600 dark:border-blue-400 dark:text-blue-400">
            Datos Personales Médicos
          </button>
          <button id="paso2Btn" class="paso-btn px-4 py-2 font-semibold text-gray-400">
            Antecedentes Médicos
          </button>
          <button id="paso3Btn" class="paso-btn px-4 py-2 font-semibold text-gray-400">
            Estado Actual
          </button>
        </div>

        <!-- Formulario Paso 1 -->
<form id="paso1" class="space-y-6">
  <div class="space-y-4">
    <div>
      <label for="enfermedades" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Enfermedades que padece el paciente? ¿Cuáles?
      </label>
      <textarea
        id="enfermedades"
        name="enfermedades"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div>
      <label for="tratamientoMedico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Está actualmente en tratamiento médico? ¿Cuál?
      </label>
      <textarea
        id="tratamientoMedico"
        name="tratamientoMedico"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div>
      <label for="medicamentos" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Consume algún medicamento con regularidad? ¿Cuál?
      </label>
      <textarea
        id="medicamentos"
        name="medicamentos"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div>
      <label for="enfermedadInfectoInfecciosa" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Padece alguna enfermedad infecto-infecciosa? ¿Cuál?
      </label>
      <textarea
        id="enfermedadInfectoInfecciosa"
        name="enfermedadInfectoInfecciosa"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="fuma"
        name="fuma"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
      />
      <label for="fuma" class="text-sm text-gray-700 dark:text-gray-300">
        ¿Fuma?
      </label>
    </div>
    <div>
      <label for="cantidadCigarrillos" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Cuánto fuma?
      </label>
      <input
        type="text"
        id="cantidadCigarrillos"
        name="cantidadCigarrillos"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      />
    </div>
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="embarazada"
        name="embarazada"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
      />
      <label for="embarazada" class="text-sm text-gray-700 dark:text-gray-300">
        ¿Está embarazada?
      </label>
    </div>
    <div>
      <label for="mesesEmbarazo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Cuántos meses de embarazo?
      </label>
      <input
        type="text"
        id="mesesEmbarazo"
        name="mesesEmbarazo"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      />
    </div>
    <div>
      <label for="otrasEnfermedades" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Desea dejar constancia de alguna otra enfermedad?
      </label>
      <textarea
        id="otrasEnfermedades"
        name="otrasEnfermedades"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div>
      <label for="alergias" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Alergias?
      </label>
      <textarea
        id="alergias"
        name="alergias"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="diabetes"
        name="diabetes"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
      />
      <label for="diabetes" class="text-sm text-gray-700 dark:text-gray-300">
        ¿Diabetes?
      </label>
    </div>
    <div>
      <label for="enfermedadTransmisionSexual" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Enfermedad de transmisión sexual? ¿Cuál?
      </label>
      <textarea
        id="enfermedadTransmisionSexual"
        name="enfermedadTransmisionSexual"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div>
      <label for="motivoConsulta" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Motivo de la consulta (completado por la secretaria):
      </label>
      <textarea
        id="motivoConsulta"
        name="motivoConsulta"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
  </div>
  <div class="flex justify-end space-x-4">
    <button
      type="button"
      id="cancelarBtn"
      class="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
    >
      Cancelar
    </button>
    <button
      type="button"
      id="siguiente1"
      class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    >
      Siguiente
    </button>
  </div>
</form>

<!-- Formulario Paso 2 -->
<form id="paso2" class="hidden space-y-6">
  <div class="space-y-4">
    <fieldset class="space-y-2">
      <legend class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Ha consultado con algún odontólogo previamente?
      </legend>
      <div class="mt-2 space-x-4">
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="consultaPrevia"
            value="si"
            class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Sí</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="consultaPrevia"
            value="no"
            class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
          />
          <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">No</span>
        </label>
      </div>
    </fieldset>
    <div>
      <label for="tratamientoOdontologico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Está llevando algún tratamiento odontológico? ¿Cuál? ¿Desde cuándo?
      </label>
      <textarea
        id="tratamientoOdontologico"
        name="tratamientoOdontologico"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div id="seccionDolor" class="space-y-4">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Presenta dolor?
      </label>
      <div class="ml-4 space-y-4">
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Rango:</p>
          <select
            name="rangoDolor"
            class="mt-1 block w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
          >
            <option value="">Seleccione...</option>
            <option value="suave">Suave</option>
            <option value="moderado">Moderado</option>
            <option value="intenso">Intenso</option>
          </select>
        </div>
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Tipo:</p>
          <select
            name="tipoDolor"
            class="mt-1 block w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
          >
            <option value="">Seleccione...</option>
            <option value="temporario">Temporario</option>
            <option value="intermitente">Intermitente</option>
            <option value="continuo">Continuo</option>
          </select>
        </div>
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Características:</p>
          <div class="mt-2 space-x-4">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="caracteristicasDolor[]"
                value="espontaneo"
                class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Espontáneo</span>
            </label>
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="caracteristicasDolor[]"
                value="provocado"
                class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Provocado</span>
            </label>
          </div>
        </div>
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-400">Sensibilidad:</p>
          <div class="mt-2 space-x-4">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="sensibilidad[]"
                value="frio"
                class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Al frío</span>
            </label>
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="sensibilidad[]"
                value="calor"
                class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Al calor</span>
            </label>
          </div>
        </div>
        <div>
          <label for="localizacionDolor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
            Localización del dolor:
          </label>
          <select
            id="localizacionDolor"
            name="localizacionDolor"
            multiple
            class="mt-1 block w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
          >
            <option value="maxilaSuperior">Maxila superior</option>
            <option value="maxilaInferior">Maxila inferior</option>
<option value="cuadranteSuperiorDerecho">Cuadrante superior derecho</option>
<option value="cuadranteSuperiorIzquierdo">Cuadrante superior izquierdo</option>
<option value="cuadranteInferiorDerecho">Cuadrante inferior derecho</option>
<option value="cuadranteInferiorIzquierdo">Cuadrante inferior izquierdo</option>
</select>
</div>
</div>
</div>
<div>
  <label for="fracturas" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
    ¿Se le ha fracturado algún diente? ¿Cuál?
  </label>
  <textarea
    id="fracturas"
    name="fracturas"
    rows="2"
    class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
  ></textarea>
</div>
<div class="flex items-center space-x-2">
  <input
    type="checkbox"
    id="dificultadMasticar"
    name="dificultadMasticar"
    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
  />
  <label for="dificultadMasticar" class="text-sm text-gray-700 dark:text-gray-300">
    ¿Tiene dificultad para masticar?
  </label>
</div>
<div class="flex items-center space-x-2">
  <input
    type="checkbox"
    id="dificultadAbrirBoca"
    name="dificultadAbrirBoca"
    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
  />
  <label for="dificultadAbrirBoca" class="text-sm text-gray-700 dark:text-gray-300">
    ¿Siente dificultad para abrir la boca?
  </label>
</div>
</div>
<div class="flex justify-end space-x-4">
  <button
    type="button"
    id="anterior2"
    class="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
  >
    Anterior
  </button>
  <button
    type="button"
    id="siguiente2"
    class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
  >
    Siguiente
  </button>
</div>
</form>
<!-- Formulario Paso 3 -->
<form id="paso3" class="hidden space-y-6">
  <div class="space-y-4">
    <div>
      <label for="anormalidadBucal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Observa alguna anormalidad en su boca (labios, lengua, paladar, etc.)? ¿Cuál?
      </label>
      <textarea
        id="anormalidadBucal"
        name="anormalidadBucal"
        rows="2"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="sangradoEncias"
        name="sangradoEncias"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
      />
      <label for="sangradoEncias" class="text-sm text-gray-700 dark:text-gray-300">
        ¿Le sangran las encías?
      </label>
    </div>
    <div class="flex items-center space-x-2">
      <input
        type="checkbox"
        id="hinchazanCara"
        name="hinchazanCara"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"
      />
      <label for="hinchazanCara" class="text-sm text-gray-700 dark:text-gray-300">
        ¿Tiene hinchazón en la cara?
      </label>
    </div>
    <fieldset class="space-y-2">
      <legend class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        ¿Cómo califica su higiene bucal?
      </legend>
      <div class="mt-2 flex flex-wrap gap-4">
        {["Muy buena", "Buena", "Mala", "Muy mala"].map((option) => (
          <label class="inline-flex items-center">
            <input
              type="radio"
              name="higieneBucal"
              value={option.toLowerCase().replace(" ", "")}
              class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">{option}</span>
          </label>
        ))}
      </div>
    </fieldset>
    <div>
      <label for="anotacionesMedico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Anotaciones del Médico
      </label>
      <textarea
        id="anotacionesMedico"
        name="anotacionesMedico"
        rows="4"
        class="mt-1 w-full rounded-md border border-gray-300 bg-white p-2 dark:border-gray-600 dark:bg-gray-700 focus:border-blue-500 focus:ring-blue-500"
      ></textarea>
    </div>
  </div>
  <div class="flex justify-end space-x-4">
    <button
      type="button"
      id="anterior3"
      class="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
    >
      Anterior
    </button>
    <button
      type="button"
      id="guardar"
      class="rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
    >
      Guardar Consulta
    </button>
  </div>
</form>

      </div>
    </div>
  </div>
</LayoutCommon>
</LayoutProtected>

<script>
const BASE_URL = 'https://consultorio-odontologico-backend-production-b1c8.up.railway.app/api';

let consultaData = {
    id: new URLSearchParams(window.location.search).get('id'),
    paso1: {},
    paso2: {},
    paso3: {}
};

async function cargarDatosCita() {
    try {
        const params = new URLSearchParams(window.location.search);
        const citaId = params.get('id');
        const motivoFromURL = params.get('motivo');

        if (!citaId) {
            throw new Error('No se proporcionó ID de cita');
        }

        const response = await fetch(`${BASE_URL}/citas/${citaId}`);
        if (!response.ok) {
            throw new Error('Error al cargar datos de la cita');
        }

        const cita = await response.json();
        console.log('Datos de la cita cargados:', cita);
        
        // Usar el motivo de la URL si está disponible, si no, usar el de la cita
        const motivoFinal = motivoFromURL || cita.motivo || '';
        
        // Pre-llenar el motivo de consulta en el paso 1
        const motivoConsultaElement = document.getElementById('motivoConsulta');
        if (motivoConsultaElement) {
            motivoConsultaElement.value = motivoFinal;
            // Guardamos el motivo original en el objeto consultaData
						console.log(motivoFinal);
            consultaData.motivoOriginal = motivoFinal;
        }

        // Guardamos los datos de la cita en el consultaData, asegurándonos de mantener el motivo
        consultaData.citaInfo = {
            ...cita,
            motivo: motivoFinal
        };

        console.log('Datos finales cargados:', {
            motivoOriginal: consultaData.motivoOriginal,
            citaInfo: consultaData.citaInfo
        });

    } catch (error) {
        console.error('Error al cargar datos de la cita:', error);
        alert('Error al cargar los datos de la consulta');
    }
}

  function mostrarPaso(numero) {
    document.querySelectorAll('form').forEach(form => form.classList.add('hidden'));
    document.getElementById(`paso${numero}`)?.classList.remove('hidden');

    document.querySelectorAll('.paso-btn').forEach(btn => {
      btn.classList.remove('text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-600', 'dark:border-blue-400');
      btn.classList.add('text-gray-400');
    });

    const botonActivo = document.getElementById(`paso${numero}Btn`);
    if (botonActivo) {
      botonActivo.classList.remove('text-gray-400');
      botonActivo.classList.add('text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-600', 'dark:border-blue-400');
    }
  }

	function recolectarDatosPaso(numero) {
    const form = document.getElementById(`paso${numero}`);
    if (!form) return;

    const formData = new FormData(form);
    const datos = {};

    formData.forEach((value, key) => {
      if (key.endsWith('[]')) {
        // Campos con múltiples valores (checkboxes)
        if (!datos[key]) {
          datos[key] = [];
        }
        datos[key].push(value);
      } else if (key === 'fuma' || key === 'diabetes' || key === 'embarazada' || key === 'dificultadMasticar' || key === 'dificultadAbrirBoca' || key === 'sangradoEncias' || key === 'hinchazanCara') {
        // Campos booleanos (checkboxes individuales)
        datos[key] = value === 'on';
      } else {
        // Campos de texto y selects
        datos[key] = value;
      }
    });

    consultaData[`paso${numero}`] = datos;
  }

	async function guardarConsulta(e) {
    if (e) e.preventDefault();
    recolectarDatosPaso(1);
    recolectarDatosPaso(2);
    recolectarDatosPaso(3);

    try {
        const pacienteId = consultaData.citaInfo.pacienteId.id || consultaData.citaInfo.pacienteId;

        const historiaClinicaData = {
            datosPersonalesMedicos: {
                enfermedades: consultaData.paso1.enfermedades || '',
                tratamientoActual: consultaData.paso1.tratamientoMedico || '',
                medicamentosRegulares: consultaData.paso1.medicamentos || '',
                enfermedadInfectoInfecciosa: consultaData.paso1.enfermedadInfectoInfecciosa || '',
                fuma: Boolean(consultaData.paso1.fuma),
                embarazo: Boolean(consultaData.paso1.embarazada),
                enfermedadConstancia: consultaData.paso1.otrasEnfermedades || '',
                alergias: consultaData.paso1.alergias || '',
                diabetes: Boolean(consultaData.paso1.diabetes),
                enfermedadTransmisionSexual: consultaData.paso1.enfermedadTransmisionSexual || '',
                motivoConsulta: consultaData.motivoOriginal || consultaData.citaInfo.motivo || ''
            },
            antecedentesMedicosOdontologicos: {
                consultoOdontologo: consultaData.paso2.consultaPrevia === 'si',
                tratamientoOdontologico: {
                    descripcion: consultaData.paso2.tratamientoOdontologico || '',
                    desdeCuando: new Date().toISOString()
                },
                dolor: JSON.stringify({
                    rango: consultaData.paso2.rangoDolor || '',
                    tipo: consultaData.paso2.tipoDolor || '',
                    caracteristicas: consultaData.paso2['caracteristicasDolor[]'] || [],
                    sensibilidad: consultaData.paso2['sensibilidad[]'] || [],
                    localizacion: consultaData.paso2.localizacionDolor || ''
                }),
                fracturaDiente: consultaData.paso2.fracturas || '',
                dificultadMasticar: Boolean(consultaData.paso2.dificultadMasticar),
                dificultadAbrirBoca: Boolean(consultaData.paso2.dificultadAbrirBoca)
            },
            estadoActual: {
                anormalidadBoca: consultaData.paso3.anormalidadBucal || '',
                sangradoEncias: Boolean(consultaData.paso3.sangradoEncias),
                hinchazonCara: Boolean(consultaData.paso3.hinchazanCara),
                higieneBucal: (consultaData.paso3.higieneBucal || 'bueno').toLowerCase()
            },
            aclaracionesFinalesMedico: consultaData.paso3.anotacionesMedico || '',
            pacienteId: pacienteId
        };

        console.log('Datos a enviar:', historiaClinicaData);

        const responseHistoriaClinica = await fetch(`${BASE_URL}/historiaClinica/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(historiaClinicaData)
        });

        if (!responseHistoriaClinica.ok) {
            const errorData = await responseHistoriaClinica.json();
            throw new Error(errorData.message || 'Error al guardar la historia clínica');
        }

        // Actualizar estado de la cita asegurándose de mantener el motivo original
        const citaUpdateData = {
            estado: 'completada',
            fecha: consultaData.citaInfo.fecha,
            motivo: consultaData.motivoOriginal || consultaData.citaInfo.motivo, // Usar el motivo original guardado
            medicoId: consultaData.citaInfo.medicoId._id || consultaData.citaInfo.medicoId,
            pacienteId: pacienteId,
            tratamientos: consultaData.citaInfo.tratamientos
        };

        console.log('Actualizando cita con:', citaUpdateData);

        const responseEstado = await fetch(`${BASE_URL}/citas/${consultaData.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(citaUpdateData)
        });

        if (!responseEstado.ok) {
            throw new Error('Error al actualizar el estado de la cita');
        }

        alert('Consulta guardada exitosamente');
        window.location.href = '/';

    } catch (error) {
        console.error('Error detallado:', error);
        alert('Error al guardar la consulta: ' + error.message);
    }
	}

  // Event Listeners
  document.getElementById('volverBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/';
  });

	document.getElementById('cancelarBtn')?.addEventListener('click', (e) => {
  e.preventDefault();
  if (confirm('¿Está seguro que desea cancelar? Se perderán los cambios no guardados.')) {
    window.location.href = '/';
  }
});

  ['paso1Btn', 'paso2Btn', 'paso3Btn'].forEach((id, index) => {
    document.getElementById(id)?.addEventListener('click', () => mostrarPaso(index + 1));
  });

  document.getElementById('siguiente1')?.addEventListener('click', () => {
    recolectarDatosPaso(1);
    mostrarPaso(2);
  });

  document.getElementById('anterior2')?.addEventListener('click', () => mostrarPaso(1));

  document.getElementById('siguiente2')?.addEventListener('click', () => {
    recolectarDatosPaso(2);
    mostrarPaso(3);
  });

  document.getElementById('anterior3')?.addEventListener('click', () => mostrarPaso(2));

  document.getElementById('guardar')?.addEventListener('click', (e) => guardarConsulta(e));

	document.addEventListener('DOMContentLoaded', () => {
    cargarDatosCita();
});

  // Inicializar mostrando el primer paso
  mostrarPaso(1);
</script>
